<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <meta charset="UTF-8">
    <title>Team Happiness</title>
    <script src="https://www.gstatic.com/charts/loader.js" type="text/javascript"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" type="text/javascript"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js" type="text/javascript"></script>
      <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript">

        $.urlParam = function(name){
            var results = new RegExp('[\?&]' + name + '=([^&]*)').exec(window.location.href);
            if (results==null){
                return null;
            }
            else{
                return results[1] || 0;
            }
        };

        var showTable;

        if($.urlParam == null || !$.urlParam('table') || $.urlParam('table') === 'false'){
            showTable = false;
        } else {
            showTable = true;
        }

        console.log(showTable);

      google.charts.load('current', {'packages':['line', 'table']});
      google.charts.setOnLoadCallback(loadChart);

    var team;

    if($.urlParam == null || !$.urlParam('team')){
        team = 'all';
    } else {
        team = $.urlParam('team');
    }

    function loadChartData(url, slug) {
          return $.ajax({
            url: url + slug + "/",
            dataType: "json"
          });
        }

    function loadChart() {
      loadChartData("/trend/weekly/", team).done(drawChart);
      if(showTable){
        console.log('showTable');
        loadChartData("/trend/weekly/", team).done(drawTable);
      }
    }

    function drawChart(data) {

     var dataTable = new google.visualization.DataTable(data);

      var options = {
        chart: {
          title: 'Team Happiness',
          subtitle: 'average happiness over time'
        },
        width: 900,
        height: 500,
        series: {
            // Gives each series an axis name that matches the Y-axis below.
            0: {targetAxisIndex: 0},
            1: {targetAxisIndex: 1}
        },
        vAxes: {
            // Adds titles to each axis.
            0: {title: 'Happiness (avg)', viewWindow:{max: 5, min: 0}},
            1: {title: 'Responses', viewWindow:{min: 0}, gridlines:{color: '#f2f2f2'}}
        },
        colors:['orange','grey']
      };

      var chart = new google.charts.Line(document.getElementById('linechart_material'));

      chart.draw(dataTable, google.charts.Line.convertOptions(options));
    }

    function drawTable(data) {

          var dataTable = new google.visualization.DataTable(data);

          var table = new google.visualization.Table(document.getElementById('table'));

          table.draw(dataTable);
      }

    $(document).ready(function(){
        if($.urlParam('success') === "true") {
            toastr.options = {
                "positionClass": "toast-top-full-width",
                "extendedTimeOut": "10000"
            };
            toastr.success('Thank you for your submission');
        }
    });
    </script>
  </head>
  <body>
    <div id="linechart_material" style="width: 900px; height: 500px"></div>
    <div id="table" ></div>
  </body>
</html>